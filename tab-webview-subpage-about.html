<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.title {
				margin: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<h5>票号</h5>
			<div class="mui-input-row">
				<input id="lhcode" type="number" class="mui-input-clear" placeholder="请输入联合票务12位电子票" value="">
			</div>
			<h5>数量</h5>
			<div class="mui-numbox" data-numbox-min='1'>
				<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
				<input id="number" class="mui-input-numbox" type="number" value="1" />
				<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
			</div>
			<div class="mui-button-row">

			</div>
			<div class="mui-button-row" id="CodeExecude">
				<button type="button" class="mui-btn mui-btn-blue" id="verifyCode">验票</button>&nbsp; &nbsp; &nbsp; &nbsp;
				<button type="button" class="mui-btn mui-btn-red" id="queryCode">查询</a>
				</div>
				<div id="tipsinfo"></div>
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script src="js/user.js" type="text/javascript" charset="utf-8"></script>
<script>
	//主列表点击事件
	var lhcode = document.getElementById('lhcode'),
		number = document.getElementById('number'),
		tipsinfo = document.getElementById("tipsinfo"),
		num = code = '',
		settings = '',
		state = ''
	exeparam = 0;
	var verifyCodeBtn = document.getElementById("verifyCode"),
		queryCodeBtn = document.getElementById("queryCode");

	mui.init({
		swipeBack: true //启用右滑关闭功能
	});
	mui.plusReady(function() {

		settings = app.getSettings();
		state = app.getState();

		token = state.token;
		if(!settings.device) {
			if(plus.device.uuid) {
				settings.device = {
					"uuid": plus.device.uuid,
					"model": plus.device.model,
					"imei": plus.device.imei
				};
				app.setSettings(settings);
			} else {
				mui.alert("请允许应用获取手机信息的权限", "无权限提示");
			}
		}
	});
	verifyCodeBtn.addEventListener('tap', function() {
		state = app.getState();
		var token = state.token;
		code = lhcode.value;
		num = number.value;
		requestbefor(this, code);
		if(num < 1) {
			mui.toast('数量不可小于1');
			return false;
		}
		mui.web_query('verifyCode', {
			token: token,
			code: code,
			num: num,
			device: settings.device
		}, onSuccess, onError, 3);
	});
	queryCodeBtn.addEventListener('tap', function() {
		state = app.getState();
		var token = state.token;
		console.log(token);
		code = lhcode.value;
		requestbefor(this, code);
		mui.web_query('queryCode', {
			token: token,
			code: code,
			device: settings.device,
		}, onSuccess, onError, 3);
	});
	var requestbefor = function(index, code) {
		if(exeparam) {
			mui.toast('不可重复提交');
			return false;
		} else {
			exeparam = 1;
		}
		index.setAttribute("disabled", true);
		if(!settings.device) {
			onError('请允许软件读取设备标识的权限');
			return false;
		}
		if((code.length < 12) || (code.length > 12)) {
			onError('请输入联合票务12位消费编码');
			return false;
		}
	}

	var onSuccess = function(data) {
		exeafter();
		mui.alert(data.msg, '成功',
			function() {
				var datainfo = data.data;
				tipsinfo.innerText = data.msg;
			});

	}
	var exeafter = function() {
		exeparam = 0;
		verifyCodeBtn.disabled = false;
		queryCodeBtn.disabled = false;
	}
	var onError = function(errcode) {
		exeafter();
		switch(errcode) {
			case 'INCORRECT_PASSWORD':
				mui.toast('密码不正确');
				break;
			case 'USER_NOT_EXISTS':
				mui.toast('用户尚未注册');
				break;
			default:
				mui.toast(errcode);
		}

	}
</script>

</html>