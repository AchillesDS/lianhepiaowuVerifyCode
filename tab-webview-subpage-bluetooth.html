<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>联合票务验票APP</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<script src="js/mui.min.js"></script>
		<style type="text/css">
			.switch-contact{		
				font-size: 12px;
			}
			.switch-contact.mui-switch.mui-active:before {
					left: 3px;
					content: '已连接';
			}
			.switch-contact.mui-switch:before {
				right: 3px;
				content: '未连接';
			}
		</style>
	</head>

	<body>
		<!--<header class="mui-bar mui-bar-nav">
            <h1 class="mui-title">打印</h1>
        </header>-->
		<div class="mui-content mui-content-padded">
			<h5 class="mui-content-padded">点击设备连接，连接成功会跳转到验票界面。验票后即可立即打印小票</h5>
			<h5 class="mui-content-padded" style="margin: 35px 10px 15px;">已配对设备</h5>
			<ul id="contactlist" class="mui-table-view mui-table-view-chevron">
				<!--<li class="mui-table-view-cell" id="BleDevice_active_mac_address">
					<a href="" class="mui-navigate-right">配对设备<span class="mui-badge mui-badge-success">已连接</span></a>
				</li>
				<li class="mui-table-view-cell" id="BleDevice_getAddress_mac_address">
					<a href="" class="mui-navigate-right">配对设备<span class="mui-badge mui-badge-warning">未连接</span></a>
				</li>-->
			</ul>
			<h5 class="mui-content-padded" style="margin: 35px 10px 15px;">未配对设备</h5>
			<ul id="nocontactlist" class="mui-table-view mui-table-view-chevron">
				<!--<li class="mui-table-view-cell" id="BleDevice_no_active_mac_address"><a href="" class="mui-navigate-right">未配对设备<span class="mui-badge mui-badge-red">未配对</span></a></li>-->
			</ul>
		</div>
		<footer id="footer" class="mui-bar mui-bar-footer">
			<button class="mui-btn mui-btn-block mui-btn-blue" id='search'>
                <span class="mui-icon mui-icon-search"></span>搜索设备
            </button>
		</footer>
		<script type="text/javascript" charset="utf-8">
			var device = null,
				BAdapter = null,
				BluetoothAdapter = null,
				uuid = null,
				UUID = null,
				main = null,
				bluetoothSocket = null,
				BluetoothDevice = null,
				IntentFilter=null;
				
				var vlist1 = document.getElementById('contactlist'); //注册容器用来显示未配对设备
				var vlist2 = document.getElementById('nocontactlist'); //注册容器用来显示未配对设备				
				//mui初始化
			mui.init({
			swipeBack:true //启用右滑关闭功能
		});
			mui.plusReady(function() {
					scan();
				});
					//获取已配对的蓝牙设备列表
			function scan() {
				main = plus.android.runtimeMainActivity();
				BluetoothAdapter = plus.android.importClass("android.bluetooth.BluetoothAdapter");
				BAdapter = BluetoothAdapter.getDefaultAdapter(); //获得本机蓝牙适配器
				
				if(!BAdapter.isEnabled()) {
					console.log('检测到未打开蓝牙,尝试打开中....');
					mui.toast('检测到未打开蓝牙,尝试打开中....');
					var status = BAdapter.enable();
					if(status){
						mui.toast('已为您开启蓝牙,正在搜索设备...');
					}else{
						mui.toast('开启蓝牙失败,请手动开启蓝牙');
						return; 
					}
				}

				var lists = BAdapter.getBondedDevices(); //获取配对的设备列表
				plus.android.importClass(lists);
				var iterator = lists.iterator();
				plus.android.importClass(iterator);
				var ul = vlist1;
				vlist1.innerHTML = '';
				while(iterator.hasNext()) {
					var d = iterator.next();
					plus.android.importClass(d);	
					
					var li1='<li class="mui-table-view-cell" id="'+d.getAddress()+'"><a href="" class="mui-navigate-right">'+d.getName()+'<span class="mui-badge mui-badge-warning">未连接</span></a></li>';
									
					var ulinto=vlist1.innerHTML;
					vlist1.innerHTML=ulinto+li1;
				}
			}
			

			//mac_address:打印机的mac地址
			function print(mac_address) {
				if(!mac_address) {
					mui.toast('请选择蓝牙打印机');
					return;
				}
				if(device == null) {
					main = plus.android.runtimeMainActivity();
					BluetoothAdapter = plus.android.importClass("android.bluetooth.BluetoothAdapter");
					BAdapter = BluetoothAdapter.getDefaultAdapter();
					device = BAdapter.getRemoteDevice(mac_address);
					plus.android.importClass(device);

				}
				//蓝牙连接或者uuid为空时，需要重新导入蓝牙socket
				if(bluetoothSocket== null||UUID ==null){					
					UUID = plus.android.importClass("java.util.UUID");
					uuid = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
				}
				
					bluetoothSocket = device.createInsecureRfcommSocketToServiceRecord(uuid);
					plus.android.importClass(bluetoothSocket);

				if(!bluetoothSocket.isConnected()) {
					console.log('检测到设备未连接，尝试连接....');
					bluetoothSocket.connect();
					if(!bluetoothSocket.isConnected()) {
						mui.toast('设备未连接，重新连接失败，请确保设备开启。');
					}else{
						mui.toast('设备已连接。');
					}
				}
				
				var lianjie=document.getElementById(mac_address);
				var span=lianjie.getElementsByClassName('mui-badge');
				if(span){					
					span[0].innerHTML="已连接";
					span[0].classList['add']('mui-badge-success');					
					span[0].classList['remove']('mui-badge-warning');
				}
				
				console.log('设备已连接 bluetoothSocket.isConnected()=' + bluetoothSocket.isConnected());

				if(bluetoothSocket.isConnected()) {
//					bluetoothSocket.start();//开启蓝牙socket连接，不开启无法打印
//					bluetoothSocket.accept();//开启蓝牙socket连接，不开启无法打印
//					bluetoothSocket.start();//开启蓝牙socket连接，不开启无法打印
					var outputStream = bluetoothSocket.getOutputStream();
					plus.android.importClass(outputStream); 
					var string = '这是王增辉的测试打印测试测试测试测试\r\n\r\n\r\n';
					var bytes = plus.android.invoke(string, 'getBytes', 'gbk');
					var clearFormat = [0x1b, 0x40]; //复位打印机
					outputStream.write(clearFormat);
					outputStream.write(bytes);
					outputStream.flush();
//					device = null //清空连接设备 如果持续验票的情况下，不能每次都初始化设备。只需要关闭蓝牙与手机APP的socket即可。无需情况设备
					bluetoothSocket.close(); //必须关闭蓝牙连接否则意外断开的话打印错误
				}
			}
			//以配对列表
			mui('#contactlist').on('tap', 'li', function() {
				print(this.id);
			});
			//为蓝牙列表下li增加触摸事件
			mui('#nocontactlist').on('tap', 'li', function() {
				contactBlueDevices(this.id);
			});
			
			document.getElementById("search").addEventListener('tap', function() {
				searchDevices();
			});
			//检测蓝牙是否开启
			function checkBluetoothIsEnabled(){
				if(!BAdapter.isEnabled()) {
					mui.toast('检测到未打开蓝牙,尝试打开中....');
					var status = BAdapter.enable();
					if(status){
						mui.toast('已为您开启蓝牙,正在搜索设备...');
					}else{
						mui.toast('开启蓝牙失败,请手动开启蓝牙');
						return false; 
					}
				}
				return true;
			}
			//检测设备是否配对
			
			//未配对的设备，此时开始连接
			function contactBlueDevices(mac_address){
				if(!mac_address) {
					mui.toast('请选择蓝牙打印机');
					return;
				}
				if(device == null) {
					main = plus.android.runtimeMainActivity();
					BluetoothAdapter = plus.android.importClass("android.bluetooth.BluetoothAdapter");
					BAdapter = BluetoothAdapter.getDefaultAdapter();
					device = BAdapter.getRemoteDevice(mac_address);
					plus.android.importClass(device);
					
				}
				if(BluetoothDevice==null){
					//蓝牙信息	
					BluetoothDevice = plus.android.importClass("android.bluetooth.BluetoothDevice");
				}
				var bdevice = new BluetoothDevice();
				if(device.getBondState()==bdevice.BOND_NONE){
					//地址一样，执行配对
					if(mac_address == device.getAddress()){
						console.log('正在执行配对');
						if(BleDevice.createBond()) {
							console.log("配对成功");
							
						}
					}					
				}				
				//蓝牙连接或者uuid为空时，需要重新导入蓝牙socket
				if(bluetoothSocket== null||UUID ==null){					
					UUID = plus.android.importClass("java.util.UUID");
					uuid = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
					bluetoothSocket = device.createInsecureRfcommSocketToServiceRecord(uuid);
					plus.android.importClass(bluetoothSocket);
				}
				if(!bluetoothSocket.isConnected()) {
					console.log('检测到设备未连接，尝试连接....');
					bluetoothSocket.connect();
					if(!bluetoothSocket.isConnected()) {
						mui.toast('设备未连接，重新连接失败，请确保设备开启。');
					}else{
						mui.toast('设备连接成功。');
					}
				}
				
				var lianjie=document.getElementById(mac_address);
				var span=lianjie.getElementsByClassName('mui-badge');
				if(span){					
					span[0].innerHTML="已连接";
					span[0].classList['add']('mui-badge-success');					
					span[0].classList['remove']('mui-badge-warning');
				}
				
				console.log('设备已连接 bluetoothSocket.isConnected()=' + bluetoothSocket.isConnected());
				if(bluetoothSocket.isConnected()) {
					if(mui.os.plus) {
						var btnArray = ['是', '否'];
						mui.confirm('蓝牙已连接成功，是否测试打印？', '测试打印', btnArray, function(e) {
							if(e.index == 0) {
								print(mac_address)
							}else{
								console.log('取消打印');
							}
						})
					} else {
						var confirmresult=confirm("蓝牙已连接成功，是否测试打印？");
						if(confirmresult){							
							print(mac_address);
						}else{
								console.log('取消测试打印');							
						}
					}
				}else{
					mui.toast('设备未连接，重新连接失败，请确保设备开启并手动连接。');
				}
			}
			//address=""搜索蓝牙//address=设备mac地址，自动配对给出mac地址的设备
			function searchDevices(address) {
				var button1 = document.getElementById('search');		
				button1.disabled = true;
				button1.innerHTML = '<span class="mui-icon mui-icon-search"></span>正在搜索请稍候';
				
				if(device == null) {
					main = plus.android.runtimeMainActivity();
					BluetoothAdapter = plus.android.importClass("android.bluetooth.BluetoothAdapter");
					BAdapter = BluetoothAdapter.getDefaultAdapter();
				}
				//检查蓝牙是否开启
				checkBluetoothIsEnabled();
				
				if(IntentFilter==null){
					IntentFilter = plus.android.importClass('android.content.IntentFilter');	
				}				
				if(BluetoothDevice==null){
					//蓝牙信息	
					BluetoothDevice = plus.android.importClass("android.bluetooth.BluetoothDevice");
				}
				var filter = new IntentFilter();
				var bdevice = new BluetoothDevice();
				var on = un = null;
				vlist2.innerHTML = ''; //清空容器vlist2.innerHTML = 
				
				BAdapter.startDiscovery(); //开启搜索
				var receiver;
				receiver = plus.android.implements('io.dcloud.android.content.BroadcastReceiver', {
					onReceive: function(context, intent) { 
						//实现onReceiver回调函数
						plus.android.importClass(intent); 
						//通过intent实例引入intent类，方便以后的‘.’操作
						//获取action
						console.log(intent.getAction()); 

						if(intent.getAction() == "android.bluetooth.adapter.action.DISCOVERY_FINISHED") {
							console.log("搜索结束")
							main.unregisterReceiver(receiver); //取消监听
							button1.disabled = false;
							button1.innerHTML = '<span class="mui-icon mui-icon-search"></span>搜索设备';
						} else {
							BleDevice = intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);
							//判断是否配对
							if(BleDevice.getBondState() == bdevice.BOND_NONE) {
								console.log("未配对蓝牙设备：" + BleDevice.getName() + '    ' + BleDevice.getAddress());
								//参数如果跟取得的mac地址一样就配对
								if(address == BleDevice.getAddress()) {
									//配对命令.createBond()
									if(BleDevice.createBond()) {
										console.log("配对成功");
										on= BleDevice.getName();
										var li1='<li class="mui-table-view-cell" id="'+BleDevice.getAddress()+'"><a href="" class="mui-navigate-right">'+on+'<span class="mui-badge mui-badge-success">已连接</span></a></li>';
										var ulinto=vlist1.innerHTML;
										vlist1.innerHTML=ulinto+li1;
										
									}else{
										mui.toast('配对失败！请手动前往蓝牙界面。取消配对后，重试！');
										return;
									}
								} else {
									//判断防止重复添加
									if(BleDevice.getName() != un) {
										un = BleDevice.getName();
										var li2 ='<li class="mui-table-view-cell" id="'+BleDevice.getAddress()+'"><a href="" class="mui-navigate-right">'+un+'<span class="mui-badge mui-badge-red">未配对</span></a></li>';
										var ulinto=vlist2.innerHTML;
										vlist2.innerHTML=ulinto+li2;
									}
								}
							} else {
								//判断防止重复添加
								if(BleDevice.getName() != on) { 
									console.log("已配对蓝牙设备：" + BleDevice.getName() + '    ' + BleDevice.getAddress());																
									on = BleDevice.getName();
									var li1='<li class="mui-table-view-cell" id="'+BleDevice.getAddress()+'"><a href="" class="mui-navigate-right">'+on+'<span class="mui-badge mui-badge-warning">未连接</span></a></li>';
									var ulinto=vlist1.innerHTML;
									vlist1.innerHTML=ulinto+li1;
								}							
							}
						}

					}
				});

				filter.addAction(bdevice.ACTION_FOUND);//搜索设备  
				filter.addAction(BAdapter.ACTION_DISCOVERY_STARTED);
				filter.addAction(BAdapter.ACTION_DISCOVERY_FINISHED);
				filter.addAction(BAdapter.ACTION_STATE_CHANGED);
				
				filter.addAction(BAdapter.ACTION_STATE_CHANGED); //监听蓝牙开关

				main.registerReceiver(receiver, filter); //注册监听
			}
		</script>
	</body>

</html>